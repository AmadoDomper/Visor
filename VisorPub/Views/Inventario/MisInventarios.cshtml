@{
    Layout = null;
}

<link href="~/Content/css/dataTables/dataTables.bootstrap.min.css" rel="stylesheet" />
<script src="~/Content/js/utils.min.js"></script>
<script src="~/Content/js/dataTables/jquery.dataTables.min.js"></script>
<script src="~/Content/js/dataTables/dataTables.bootstrap.js"></script>

<script type="text/javascript">
        var Model = @Html.Raw(Json.Encode(@Model));
</script>

<div class="col-lg-11 col-lg-offset-0-5">
    <input id="hdnEstado" type="hidden" />
    <input id="hdnPubEst" type="hidden" />
    <input id="hdnPag" type="hidden" />
    @*<div class="row">*@
    <div id="target1" class="panel move panel-inverse active m-t-5">
        <div class="panel-heading"><span class="glyphicon glyphicon-th" aria-hidden="true"></span> Mis Inventarios de Vegetación</div>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <input href="#target2" id="btnNuevoInventarioVegetacion" type="button" class="btn btn-sm btn-success target" value="Registre su inventario" />
                </div>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="row m-b-10 m-t-10">
                <div class="col-sm-11">
                    <div class="form-inline">
                        <div class="form-group m-r-40">
                            <label class="control-label m-r-5" for="status">Mostrar inventario estado:</label>
                            <select name="status" id="cmbInvEstado" class="form-control">
                                <option value="1" selected="">Solicitado</option>
                                <option value="2">Aprobado</option>
                                <option value="3">Rechazado</option>
                                <option value="4">Observado</option>
                                <option value="5">Anulado</option>
                            </select>
                        </div>
                        <div class="form-group m-r-10">
                            <label class="control-label m-r-5" for="product_name">Buscar por:</label>
                            <select name="status" id="cmbTpoBsq" class="form-control">
                                <option value="1" selected="">Título del Proyecto</option>
                                <option value="2">Año</option>
                                @*<option value="4">Rango de Fecha</option>*@
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="text" id="txtValor" class="form-control">
                            <div class="input-daterange input-group" id="dtRango" style="display: none;">
                                <input id="txtFI" type="text" class="form-control" name="start">
                                <span class="input-group-addon">al</span>
                                <input id="txtFF" type="text" class="form-control" name="end">
                            </div>
                        </div>
                        <input id="btnBuscarInv" type="button" value="Buscar" class="btn btn-sm btn-primary">
                    </div>
                </div>
            </div>
            <div class="row table-main">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div id="cntListaInvVegetacion" class="table-responsive">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="target2" class="panel move panel-inverse m-t-5" data-sortable-id="form-stuff-1" style="display: none;">
        <div class="panel-heading">
            <h4 class="panel-title">Inventario de Vegetación</h4>
        </div>
        <div class="panel-body" style="display: block;">
            <div class="row">
                <div class="col-lg-12">
                    <form id="frm" class="form-horizontal" data-smk-icon="glyphicon-asterisk">
                        <div class="form-group">
                            <label class="control-label col-xs-12 col-sm-2 col-md-3 col-lg-2" for="email">Código Proyecto</label>
                            <div class="col-xs-5 col-sm-2">
                                <input type="text" class="form-control" id="txtCodProy">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-2 col-md-3 col-lg-2" for="pwd">Nombre del Proyecto:</label>
                            <div class="col-sm-10 col-md-8">
                                <input type="text" class="form-control" id="txtNombProy">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-xs-12 col-sm-2 col-md-3 col-lg-2" for="pwd">Año Colecta:</label>
                            <div class="col-xs-5 col-sm-2 col-md-2">
                                <input type="text" class="form-control" id="txtAno">
                            </div>
                        </div>
                        <div id="cntListaInvParcelas" class="table-responsive">
                            <table id="tblParcelas" class="table table-striped table-bordered dataTable"> </table>
                        </div>

                        <div class="row m-t-5">
                            <div class="col-md-8"></div>
                            <div class="col-md-2">
                                <input type="button" class="btn btn-primary btn-block btn-fill" value="Enviar" id="btenviar" name="btenviar">
                            </div>
                            <div class="col-md-2">
                                <input type="button" class="btn btn-default btn-block btn-fill" value="Cancelar" id="btcancelar" name="btcancelar">
                            </div>
                        </div>
                    </form>

                </div>
            </div>

        </div>
    </div>

</div>

<div id="modalParcela" class="modal fade" role="dialog"> 
    <div class="modal-dialog modal-lg">

        <!-- Modal content-->
        <div class="modal-content">
            <form id="frmRegistro" class="form-vertical" action="" autocomplete="off">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">×</button>
                    <h4 class="modal-title">Registrar Parcela</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <input type="hidden" class="form-control" id="hdnVegId">
                                <input type="hidden" class="form-control" id="hdnParId">
                                <label class="control-label" for="txtDepartamento">Departamento</label>
                                <input type="text" class="form-control" id="txtDepartamento" name="txtDepartamento">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtRegistrador">Registrador</label>
                                <input type="text" class="form-control" id="txtRegistrador" name="txtRegistrador">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtLongitud">Longitud</label>
                                <input type="text" class="form-control" id="txtLongitud" name="txtLongitud">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtLatitud">Latitud</label>
                                <input type="text" class="form-control" id="txtLatitud" name="txtLatitud">
                            </div>

                            <div class="form-group">
                                <label class="control-label" for="txtCodMuestra">Código Muestra</label>
                                <input type="text" class="form-control" id="txtCodMuestra" name="txtCodMuestra">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtAltitud">Altitud</label>
                                <input type="text" class="form-control" id="txtAltitud" name="txtAltitud">
                            </div><div class="form-group">
                                <label class="control-label" for="txtPrecision">Precisión</label>
                                <input type="text"  class="form-control" id="txtPrecision" name="txtPrecision">
                            </div>

                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label" for="txtTipoVeg">Tipo de Vegetación</label>
                                <input type="text" class="form-control" id="txtTipoVeg" name="txtTipoVeg">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtClaseFisonomica">Clase Fisonómica</label>
                                <input type="text" class="form-control" id="txtClaseFisonomica" name="txtClaseFisonomica">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtCobertura">Cobertura</label>
                                <input type="text" class="form-control" id="txtCobertura" name="txtCobertura">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtConClasi">Confianza Clasificación</label>
                                <input type="text" class="form-control" id="txtConClasi" name="txtConClasi">
                            </div>

                            <div class="form-group">
                                <label class="control-label" for="txtClaHidro">Clase Hidrológica</label>
                                <input type="text" class="form-control" id="txtClaHidro" name="txtClaHidro">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtFisiografia">Fisiografía</label>
                                <input type="text" class="form-control" id="txtFisiografia" name="txtFisiografia">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="txtAltitudHidrico">Altitud Sistema Hídrico</label>
                                <input type="text" class="form-control" id="txtAltitudHidrico" name="txtAltitudHidrico">
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button id="btnGuardar" type="button" class="btn btn-primary"> <span class="fa fa-save" aria-hidden="true"></span>  Guardar</button>
                    <button id="btnCancelar" type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    let datos = [];

    let vegetacionId = $('#hdnVegId');
    let parcelaId = $('#hdnParId');
    let modalParcela = $('#modalParcela');
    let departamento = $("#txtDepartamento");
    let registrador = $("#txtRegistrador");
    let longitud = $("#txtLongitud");
    let latitud = $("#txtLatitud");
    let codMuestra = $("#txtCodMuestra");
    let altitud = $("#txtAltitud");
    let precision = $("#txtPrecision");
    let tipoVeg = $("#txtTipoVeg");
    let claseFisonomica = $("#txtClaseFisonomica");
    let cobertura = $("#txtCobertura");
    let conClasi = $("#txtConClasi");
    let claHidro = $("#txtClaHidro");
    let fisiografia = $("#txtFisiografia");
    let altitudHidrico = $("#txtAltitudHidrico");

    //Asigna eventos a los elementos
    $("#btnGuardar").click(GuardaInventarioVegParcelas);

    jQuery(function ($) {
        $('input.target').click(function () {
            vista($(this).attr('href'));
        });
    });

    let vista = function ($target) {
        var $target = $($target),
            $other = $('.panel-inverse.active');

        if (!$target.hasClass('active')) {
            $other.each(function (index, self) {
                let $this = $(this);
                $this.removeClass('active').animate({
                    left: $this.width()
                }, 500).hide();
            });

            $target.addClass('active').show().css({
                left: -($target.width())
            }).animate({
                left: 0
            }, 500);
        }
    };

    ListarMisInvVeg();

    function ListarMisInvVeg(nPage, nSize, blo) {
        let cNombreProy, cAno;
        let nPubEst = $("#cmbInvEstado").val();
        let tpoBsq = $("#cmbTpoBsq").val();
        let valor = $("#txtValor").val();
        valor = valor == "" ? null : valor;

        switch (tpoBsq) {
            case "1":
                {
                    cNombreProy = valor;
                    break;
                }
            case "2":
                {
                    cAno = valor;
                    break;
                }
        }

        $.fn.Conexion({
            direccion: '@Url.Action("ListarMisInventariosVegetacion", "Inventario")',
            datos: { "nInvEst": nPubEst, "nPage": nPage, "nSize": nSize, "cNombreProy": cNombreProy, "cAno": cAno },
            bloqueo: blo == false ? false : true ,
            terminado: function (data) {
                let d = JSON.parse(data);

                $("#cntListaInvVegetacion").Tabla({
                    tblId: "tblInvVegetacion",
                    cabecera: "#,Nombre del Proyecto,Año Colecta,F. Creación,Usuario, Estado",
                    campos: "nVegId,cNombreProyecto,cAnoColecta, dFechaRegistro, oUsuario.cNom, nEstado",
                    scrollVertical: "Si",
                    tipoCampo: ",,,,,",
                    alinear: "C,L,C,C,C,C",
                    cellLen: "50,200,100,100,80,80,50",
                    cantRegVertical: 15,
                    pag: true,
                    pagDato: { "nPage": d.nPage, "nPageTot": d.nPageTot, "nPageSize": d.nPageSize, "nRows": d.nRows },
                    pagEvent: ListarMisInvVeg,
                    edit: true,
                    dblClick: true,
                    editEvent: function (fila) {
                        let nVegId = fila.find("td").eq(0).html();
                        $("#hdnEstado").val("E");
                        $('input.target')[0].click();
                        console.log(nVegId);
                        ListarParcelas(nVegId)

                    },
                    datos: d.oLista
                });
            }
        });
    }

    function ListarParcelas(nVegId) {
        $.fn.Conexion({
                direccion: '@Url.Action("CargaDatosInventarioVegetacionParcelas", "Inventario")',
                datos: { "nVegId": nVegId },
                terminado: function (data, textStatus, jqXHR) {
                    let oInv = JSON.parse(data);
                    datos = oInv;
                    console.log(oInv);
                    CrearTabla(oInv);

                    //$("#hdnPubEst").val(oPub.nEstado);
                    //$('#txtTitulo').val(oPub.titulo);
                    //$('#ddlTipo').val(oPub.tipo.Id);
                    //$('#ddlTema').val(oPub.lsTemas[0].id);
                    //$('#txtAnoPublicacion').val(oPub.ano);
                    //$('#txtEnlace').val(oPub.enlace);
                    //$('#txtReferencia').val(oPub.refBi);
                    //for (var i = 0; i < oPub.lsFeatures.length; i++) {
                    //    var punto = oPub.lsFeatures[i].Info.split(' ');
                    //        indexFeature++;

                    //    var info = punto[0] + '|' + punto[1];
                    //    var item = { "n": indexFeature, "Tipo": 1, "Info": info,"Longitud": punto[0], "Latitud": punto[1]};
                    //    $("#jsGrid").jsGrid("insertItem", item);

                    //    lsFeatures.push(item);
                    //    map_AgregarPunto(punto,indexFeature);

                    //}

                    //map.updateSize();

                    //if (oPub.nEstado == 1) {
                    //    SetEstadoSolicitado();
                    //}
                },
                bloqueo: true
        });
    }

    function CrearTabla(rows) {
        let table = `
                                <thead>
                                    <th> Eliminar </th>
                                    <th> Editar </th>
                                    <th> Departamento </th>
                                    <th> Registrador </th>
                                    <th> Longitud </th>
                                    <th> Latitud </th>
                                    <th> Código Muestra </th>
                                    <th> Altitud </th>
                                    <th> Precisión </th>
                                    <th> Tipo de Vegetación </th>
                                    <th> Clase Fisonómica </th>
                                    <th> Cobertura </th>
                                    <th> Confianza Clasificación </th>
                                    <th> Clase Hidrológica </th>
                                    <th> Fisiografía </th>
                                    <th> Altitud Sistema Hídrico </th>
                                </thead>
                                <tbody>
                                `;

        if (rows != undefined) {
            for (let i = 0; i < rows.length; i++) {
                table += `
                                    <tr index='${i}'>
                                        <td><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></td>
                                        <td><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></td>
                                        <td>${rows[i].cDepartamento}</td>
                                        <td>${rows[i].cRegistrador}</td>
                                        <td>${rows[i].cLongitud}</td>
                                        <td>${rows[i].cLatitud}</td>
                                        <td>${rows[i].cCodigoMuestra}</td>
                                        <td>${rows[i].cAltitud}</td>
                                        <td>${rows[i].cPrecision}</td>
                                        <td>${rows[i].cTipoVegetacion}</td>
                                        <td>${rows[i].cClaseFisonomica}</td>
                                        <td>${rows[i].cCobertura}</td>
                                        <td>${rows[i].cConfianzaClasificacion}</td>
                                        <td>${rows[i].cClaseHidrologica}</td>
                                        <td>${rows[i].cFisiografia}</td>
                                        <td>${rows[i].cAltitudSistemaHidrico}</td>
                                    </tr>`;
            }
        }

        table += `
                    </tbody>`;

        $('#tblParcelas').html(table);

        $("#tblParcelas").dataTable().fnDestroy();

        $('#tblParcelas').DataTable({
            "paging": false,
            "ordering": true,
            "info": true,
            "language": {
                "info": "Total: _MAX_ | Encontrados: _END_ ",
                "infoEmpty": "Total: _MAX_ | Encontrados: _END_ ",
                "infoFiltered": "",
            },
            "scrollY": "250px",
            "scrollCollapse": false,
            "bFilter": true,
            'columnDefs': [
                {
                    "targets": 0, // your case first column
                    "className": "text-center pointer",
                    "width": "4%"
                },
                {
                    "targets": 1,
                    "className": "text-center",
                },
                {
                    "targets": 6,
                    "className": "text-center",
                },
                {
                    "targets": 7,
                    "className": "text-center",
                }],
        });

        AsignarEventoClick();

    }

    function AsignarEventoClick() {
        $("#tblParcelas tr td:nth-child(2)") .bind("click", function () {
            let index = $(this).parent().attr('index');
            console.log(index);

            console.log(datos[index]);
            MostrarFormularioRegistroParcelas();
            CargarDatosFormularioParcelas(datos[index]);
        });

        //$("#tblconfirmaciones tr td").not("td:first-child, td:nth-child(7), td:nth-child(8)").bind("dblclick", function () {
        //    let index = $(this).parent().attr('index');
        //    console.log(index);
        //    MostrarFormularioRegistro();
        //    CargarDatosFormularioRegistro(datos[index]);
        //});

    }

    function MostrarFormularioRegistroParcelas() {
        modalParcela.modal('show');
    }

    function CargarDatosFormularioParcelas(par) {
        vegetacionId.val(par.nVegetacionId);
        parcelaId.val(par.nParcelaId);
        departamento.val(par.cDepartamento);
        registrador.val(par.cRegistrador);
        longitud.val(par.cLongitud);
        latitud.val(par.cLatitud);
        codMuestra.val(par.cCodigoMuestra);
        altitud.val(par.cAltitud);
        precision.val(par.cPrecision);
        tipoVeg.val(par.cTipoVegetacion);
        claseFisonomica.val(par.cClaseFisonomica);
        cobertura.val(par.cCobertura);
        conClasi.val(par.cConfianzaClasificacion);
        claHidro.val(par.cClaseHidrologica);
        fisiografia.val(par.cFisiografia);
        altitudHidrico.val(par.cAltitudSistemaHidrico);
    }

    function GuardaInventarioVegParcelas() {

        let parcela = {
            'nVegetacionId': vegetacionId.val(),
            'nParcelaId': parcelaId.val(),
            'cDepartamento': departamento.val(),
            'cRegistrador': registrador.val(),
            'cLongitud': longitud.val(),
            'cLatitud': latitud.val(),
            'cCodigoMuestra': codMuestra.val(),
            'cAltitud': altitud.val(),
            'cPrecision': precision.val(),
            'cTipoVegetacion': tipoVeg.val(),
            'cClaseFisonomica': claseFisonomica.val(),
            'cCobertura': cobertura.val(),
            'cConfianzaClasificacion': conClasi.val(),
            'cClaseHidrologica': claHidro.val(),
            'cFisiografia': fisiografia.val(),
            'cAltitudSistemaHidrico': altitudHidrico.val()
        }


        $.fn.Conexion({
            direccion: '@Url.Action("ActualizaInventarioVegetacionParcelas", "Inventario")',
            datos: parcela,
            terminado: function (data, textStatus, jqXHR) {
                let id = JSON.parse(data);
                console.log(data);
                $('#modalParcela').modal('toggle');
                ListarParcelas(parcela.nVegetacionId);  
            },
            bloqueo: true
        });


    }



    function SetEstadoSolicitado() {
        $("#target2 :input").prop("disabled", true);
        $("#btcancelar").prop("disabled", false);
    }

    $("#btcancelar").bind("click", function () {
        Limpiar();
        vista("#target1");
    });

    $("#btnNuevaPublicacion").bind("click", function () {
        map.updateSize();
    });

    $("#btnBuscarInv").bind("click", function () {
        ListarMisInvVeg();
    });

    $("#txtValor").keyup(function (e) {
        if (e.which == 13) { ListarMisInvVeg(); }
    });

    function Limpiar() {
        $('#frm')[0].reset();
        $("#target2 :input").prop("disabled", false);
    }



</script>